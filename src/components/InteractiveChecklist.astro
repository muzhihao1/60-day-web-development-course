---
/**
 * äº¤äº’å¼æ£€æŸ¥æ¸…å•ç»„ä»¶
 * ç”¨äºæ›¿æ¢é™æ€çš„Markdownæ£€æŸ¥æ¸…å•ï¼Œä½¿å…¶å¯ä»¥è¢«å‹¾é€‰
 */
export interface Props {
  items: string[]
  storageKey?: string
}

const { items, storageKey = 'checklist' } = Astro.props
const checklistId = `checklist-${Math.random().toString(36).substr(2, 9)}`
---

<div class="interactive-checklist" data-checklist-id={checklistId} data-storage-key={storageKey}>
  <div class="checklist-header">
    <h2>âœ… ä»Šæ—¥æ£€æŸ¥æ¸…å•</h2>
    <span class="checklist-progress">
      <span class="progress-count">0</span> / {items.length} å®Œæˆ
    </span>
  </div>
  <p class="checklist-description">ç¡®ä¿ä½ å·²å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š</p>
  <div class="checklist-items">
    {items.map((item, index) => (
      <div class="checklist-item">
        <input 
          type="checkbox" 
          id={`${checklistId}-item-${index}`}
          class="checklist-checkbox"
          data-index={index}
        />
        <label for={`${checklistId}-item-${index}`}>{item}</label>
      </div>
    ))}
  </div>
  <div class="checklist-actions">
    <button class="btn-reset" aria-label="é‡ç½®æ¸…å•">
      ğŸ”„ é‡ç½®æ¸…å•
    </button>
  </div>
</div>

<style>
  .interactive-checklist {
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    margin: var(--space-8) 0;
    position: relative;
  }

  .checklist-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
  }

  .checklist-header h2 {
    margin: 0;
    font-size: var(--text-xl);
    color: var(--text-primary);
  }

  .checklist-progress {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background-color: var(--bg-tertiary);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--text-secondary);
  }

  .progress-count {
    color: var(--color-success);
    font-weight: 600;
  }

  .checklist-description {
    color: var(--text-secondary);
    margin-bottom: var(--space-4);
  }

  .checklist-items {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .checklist-item {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .checklist-item:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-sm);
  }

  .checklist-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: var(--color-success);
    flex-shrink: 0;
  }

  .checklist-checkbox:checked + label {
    text-decoration: line-through;
    color: var(--text-tertiary);
  }

  .checklist-item label {
    cursor: pointer;
    flex: 1;
    color: var(--text-primary);
    transition: all var(--transition-fast);
    user-select: none;
  }

  .checklist-item.completed {
    background-color: var(--bg-secondary);
    border-color: var(--color-success);
    opacity: 0.8;
  }

  .checklist-actions {
    margin-top: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
  }

  .btn-reset {
    padding: var(--space-2) var(--space-4);
    background-color: var(--bg-tertiary);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .btn-reset:hover {
    background-color: var(--bg-secondary);
    border-color: var(--text-secondary);
    color: var(--text-primary);
  }

  @media (max-width: 768px) {
    .interactive-checklist {
      padding: var(--space-4);
    }

    .checklist-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-2);
    }

    .checklist-item {
      padding: var(--space-2) var(--space-3);
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // è·å–æ‰€æœ‰æ£€æŸ¥æ¸…å•å®ä¾‹
    const checklists = document.querySelectorAll('.interactive-checklist')
    
    checklists.forEach((checklist) => {
      const checklistId = checklist.getAttribute('data-checklist-id')
      const storageKey = checklist.getAttribute('data-storage-key')
      const checkboxes = checklist.querySelectorAll('.checklist-checkbox') as NodeListOf<HTMLInputElement>
      const progressCount = checklist.querySelector('.progress-count')
      const resetBtn = checklist.querySelector('.btn-reset')
      
      // ç”Ÿæˆå”¯ä¸€çš„å­˜å‚¨é”®
      const fullStorageKey = `${storageKey}-day-${window.location.pathname.split('/').pop()}`
      
      // ä»localStorageæ¢å¤çŠ¶æ€
      function restoreState() {
        const saved = localStorage.getItem(fullStorageKey)
        if (saved) {
          try {
            const states = JSON.parse(saved)
            checkboxes.forEach((cb, index) => {
              cb.checked = states[index] || false
              updateItemStyle(cb)
            })
            updateProgress()
          } catch (e) {
            console.error('Error restoring checklist state:', e)
          }
        }
      }
      
      // æ›´æ–°è¿›åº¦
      function updateProgress() {
        const checked = Array.from(checkboxes).filter(cb => cb.checked).length
        if (progressCount) {
          progressCount.textContent = checked.toString()
        }
        
        // å¦‚æœå…¨éƒ¨å®Œæˆï¼Œæ·»åŠ å®ŒæˆåŠ¨ç”»
        if (checked === checkboxes.length && checked > 0) {
          checklist.classList.add('all-completed')
          // å¯ä»¥åœ¨è¿™é‡Œè§¦å‘ä¸€äº›åº†ç¥åŠ¨ç”»
          setTimeout(() => {
            checklist.classList.remove('all-completed')
          }, 1000)
        }
      }
      
      // ä¿å­˜çŠ¶æ€åˆ°localStorage
      function saveState() {
        const states = Array.from(checkboxes).map(cb => cb.checked)
        localStorage.setItem(fullStorageKey, JSON.stringify(states))
      }
      
      // æ›´æ–°å•é¡¹æ ·å¼
      function updateItemStyle(checkbox: HTMLInputElement) {
        const item = checkbox.closest('.checklist-item')
        if (item) {
          if (checkbox.checked) {
            item.classList.add('completed')
          } else {
            item.classList.remove('completed')
          }
        }
      }
      
      // ç›‘å¬checkboxå˜åŒ–
      checkboxes.forEach((checkbox) => {
        checkbox.addEventListener('change', () => {
          updateItemStyle(checkbox)
          updateProgress()
          saveState()
        })
      })
      
      // é‡ç½®æŒ‰é’®
      resetBtn?.addEventListener('click', () => {
        const confirmed = confirm('ç¡®å®šè¦é‡ç½®æ¸…å•å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰å·²å‹¾é€‰çš„é¡¹ç›®ã€‚')
        if (confirmed) {
          checkboxes.forEach(cb => {
            cb.checked = false
            updateItemStyle(cb)
          })
          updateProgress()
          saveState()
        }
      })
      
      // åˆå§‹åŒ–
      restoreState()
    })
  })
</script>